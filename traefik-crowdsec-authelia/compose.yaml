services:
  traefik:
    container_name: traefik
    hostname: traefik
    image: traefik:3
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    depends_on:
      - crowdsec
    # ports:
    #   - 80:80
    #   - 443:443
    #   - 81:81
    #   - 444:444

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik:/etc/traefik
      - ./traefik/logs:/var/log/traefik
    environment:
      - TZ=${TZ}
      - CF_DNS_API_TOKEN=${CF_DNS_API_TOKEN}
      - DOMAIN=${DOMAIN}
      - EMAIL=${EMAIL}
    networks:
      lan_access:
        ipv4_address: 192.168.20.2
      frontend: null
      backend: null
    labels:
      - crowdsec.enable=true
      - crowdsec.labels.type=traefik
      - traefik.enable=true
      - traefik.docker.network=frontend
      - traefik.http.routers.traefik.entrypoints=homesec
      - traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN}`)
      - traefik.http.routers.traefik.service=api@internal
      - net.unraid.docker.managed=composeman
      - net.unraid.docker.webui=http://192.168.20.2:8080/dashboard/
      - net.unraid.docker.icon=https://raw.githubusercontent.com/ibracorp/unraid-templates/master/icons/traefik.png
      - net.unraid.docker.shell=sh
  authelia:
    container_name: authelia
    hostname: authelia
    image: authelia/authelia:latest
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./authelia:/config
    networks:
      - frontend
    expose:
      - 9091
    environment:
      - TZ=${TZ}
    healthcheck:
      disable: true
    labels:
      - traefik.enable=true
      - traefik.http.routers.authelia.rule=Host(`auth.${DOMAIN}`)
      - traefik.http.routers.authelia.entrypoints=websecure,homesec
      - traefik.http.routers.authelia.tls=true
      - traefik.http.middlewares.authelia.forwardauth.address=http://authelia:9091/api/verify?rd=https://auth.${DOMAIN}
      - traefik.http.middlewares.authelia.forwardauth.trustForwardHeader=true
      - traefik.http.middlewares.authelia.forwardauth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Name,Remote-Email
      - net.unraid.docker.managed=composeman
      - net.unraid.docker.webui=http://[IP]:[PORT:9091]/
      - net.unraid.docker.icon=https://raw.githubusercontent.com/ibracorp/app-logos/main/authelia/authelia.png
      - net.unraid.docker.shell=bash
  crowdsec:
    container_name: crowdsec
    hostname: crowdsec
    image: crowdsecurity/crowdsec:latest
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test:
        - CMD
        - cscli
        - version
      timeout: 2s
      interval: 20s
      retries: 5
      start_period: 10s
    ports:
      - 8081:8080/tcp
      - 6060:6060/tcp
      - 7422:7422/tcp
    volumes:
      - ./crowdsec/data:/var/lib/crowdsec/data
      - ./crowdsec/config:/etc/crowdsec
      - ./traefik/logs:/var/log/traefik/:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/log/auth.log/:/var/log/auth.log:ro
      - /var/log/syslog:/var/log/syslog:ro
    environment:
      - TZ=${TZ}
      - COLLECTIONS=crowdsecurity/traefik crowdsecurity/http-cve
        crowdsecurity/appsec-generic-rules crowdsecurity/appsec-virtual-patching
        crowdsecurity/appsec-crs crowdsecurity/sshd crowdsecurity/linux
        crowdsecurity/base-http-scenarios firix/authentik
        Dominic-Wagner/vaultwarden
      - PUID=${ENV_PUID}
      - PGID=${ENV_PGID}
    networks:
      - frontend
      - backend
    labels:
      - net.unraid.docker.managed=composeman
      - net.unraid.docker.webui=http://[IP]:[PORT:8081]/
      - net.unraid.docker.icon=https://raw.githubusercontent.com/ibracorp/app-logos/main/crowdsec/crowdsec.png
      - net.unraid.docker.shell=sh
networks:
  frontend:
    external: true
  backend:
    external: true
  lan_access:
    name: br0
    external: true
